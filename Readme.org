#+STARTUP: indent
#+STARTUP: showstars 
#+PROPERTY: ClearOnSave true 
#+PROPERTY: header-args:bash  :prologue "exec 2>&1" :epilogue ":"
#+PROPERTY: header-args :mkdirp yes
* Configuration
** Auto-execute
This code block will execute all the code blocks required to get your system setup. The output of this code block will appear in the Messages buffer
#+name: Execute-On-Load
#+begin_src elisp :noweb yes :results output
  ;; Setting default docker
    (org-babel-lob-ingest "~/Dropbox/projects/CHAI/repos/CHAI-LibrayOfBabble/CHAI-Tools.org")
    (org-sbe "CHAI-Tools_Init")
    ;; Auto tangle and results removeal (for cleaner git diffs)
    (org-sbe "Clear-Results-On-Save")
    (org-sbe "Tangle-On-Save")
#+end_src
#+begin_src elisp :noweb yes :results output
    (setq-local *docker_id* "emacs_docker")
    (setq-local *DockerFiles* "container/")
    (setq-local *TrampPrefix* "./")
#+end_src
 
** Org Code
*** Set Tramp General targets 
 
#+name:SetTrampTargetrDocker
 #+begin_src elisp :var Location=`,*docker_id*
  (setq-local *TrampPrefix* (concat "/docker:" Location ":/home/"))
 #+end_src
 
#+name:SetTrampTargetLocal
 #+begin_src elisp :var Location=""
  (setq-local *TrampPrefix* Location)
 #+end_src
  
 
*** Reading Container Logs  
#+name:BashDecolor
 #+begin_src bash :var dockerID=`,*docker_id* :results raw drawer 
 perl -pe 's/\e\[?.*?[\@-~]//g'
#+end_src
#+name:DockerLog
 #+begin_src bash :noweb yes :var dockerID=`,*docker_id* :results raw drawer 
   docker logs $dockerID | <<BashDecolor>> | tail -n 10
 #+end_src
 
#+name:DockerLogInSession
 #+begin_src bash :noweb yes :session DockerLog :var dockerName=`,*docker_id* :results none 
   docker logs -f $dockerName | <<BashDecolor>>
   #need a C-g to return, but leaves real-time loging in other buffer
 #+end_src
  
** Git Ignore tangled file
#+begin_src text :tangle .gitignore
  .gitignore
  container/
  .dockerignore
#+end_src
* Dev Tools
** ssh
   #+begin_src bash 
     cp ~/Dropbox/keys/gitKey ~/.ssh/gitKey
   #+end_src
  
   #+begin_src bash :tangle ssh-config
     Host github.com
      HostName github.com
      User git
      IdentityFile ~/.ssh/gitKey
   #+end_src
** git
*** install
 #+begin_src bash
     sudo apt install git
   #+end_src
*** setup
   #+begin_src bash
     #set identity 
     git config --global user.name "Douglas Perrin"
     git config --global user.email "doug2024@gmail.com"
   #+end_src
** Conda
   #+begin_src bash
     cd /tmp
     curl -O https://repo.anaconda.com/archive/Anaconda3-2019.03-Linux-x86_64.sh
     bash Anaconda3-2019.03-Linux-x86_64.sh
     source ~/.bashrc
   #+end_src
   #+begin_src bash
   conda create --name emacs python=3.6 
   #+end_src 

** AWS CLI 
** Emacs
*** Prepare
   #+begin_src bash 
     git clone -b master git://git.sv.gnu.org/emacs.git

     sudo apt-get update
     sudo apt-get install build-essential automake texinfo libjpeg-dev libncurses5-dev
     sudo apt-get install libtiff5-dev libgif-dev libpng-dev libxpm-dev libgtk-3-dev libgnutls28-dev 
      
     sudo apt-get install libtiff5-dev libgif-dev libpng-dev libxpm-dev libgtk-3-dev libgnutls28-dev libmagickcore-dev libmagick++-dev


   #+end_src
*** Build and Install  
   #+begin_src bash
     cd emacs/
     ./autogen.sh 
     ./configure --with-imagemagick
  make
     src/emacs --version
     sudo make install
   #+end_src
*** Install Ispell
    #+begin_src bash  
      sudo apt install ispell
    #+end_src
** Spacemacs
   #+begin_src bash
     cd ~
     git clone https://github.com/syl20bnr/spacemacs ~/.emacs.d
     cd ~/.emacs.d
     git fetch
     git checkout develop
     ln -s  ~/Dropbox/dotFiles/dotspacemacs-tangled.el .spacemacs
   #+end_src 
*** fonts
    #+begin_src bash 
      git clone --depth 1 --branch release https://github.com/adobe-fonts/source-code-pro.git ~/.fonts/adobe-fonts/source-code-pro
      fc-cache -f -v ~/.fonts/adobe-fonts/source-code-pro
    #+end_src
** Slime/ Common LISP 
     ;;(load (expand-file-name "~/quicklisp/slime-helper.el"))
 git clone https://github.com/slime/slime.git

     #+begin_src bash
      sudo apt install sbcl sbcl-doc sbcl-source slime 
     #+end_src
    
     #+begin_src bash
       mkdir ~/quicklisp/
       cd ~/quicklisp/
       wget https://beta.quicklisp.org/quicklisp.lisp
     #+end_src

    
    and run the following in SBCL (sbcl --load path/of/quicklisp.lisp)
    #+begin_src lisp
      (quicklisp-quickstart:install)
      (ql:add-to-init-file)
      (ql:quickload "quicklisp-slime-helper")
    #+end_src
    ~M-x slime~ Then test
    #+begin_src lisp
      (+ 1 2)
    #+end_src
   
** R
   #+begin_src bash
     sudo apt install r-base-core 
   #+end_src


   #+begin_src R :session *R*  
     install.packages("ggplot2")
     install.packages("plot3D")

   #+end_src


*** for R studio 
   #+begin_src bash
     cd /tmp
     wget https://download1.rstudio.org/desktop/bionic/amd64/rstudio-1.2.1335-amd64.deb
     sudo apt install gdebi-core
     sudo gdebi rstudio-1.2.1335-amd64.deb
   #+end_src

** Latex, Beamer, PDF preview in Emacs
   #+begin_src bash
 sudo apt install ghostscript 
 sudo apt install texlive-full
   #+end_src
* Dockerized 
** Dockerfiles

 #+begin_src text :tangle (concat *TrampPrefix* *DockerFiles* "Dockerfile-emacs_base")
      FROM ubuntu:18.04

      ENV DEBIAN_FRONTEND noninteractive

      # basic stuff
      RUN echo 'APT::Get::Assume-Yes "true";' >> /etc/apt/apt.conf 

      RUN apt-get update --fix-missing
 
      RUN apt-get install \
          bash \
          build-essential \
          dbus-x11 \
          fontconfig \
          git \
          curl \
          gzip \
          language-pack-en-base \
          libgl1-mesa-glx \
          make \
          sudo \
          tar \
          unzip 
      RUN apt-get install \
          wget \
          apt-utils \
          automake \
          texinfo \
          libjpeg-dev \
          libncurses5-dev

      RUN  git clone -b master git://git.sv.gnu.org/emacs.git

      RUN apt-get install libtiff5-dev 
      RUN apt-get install libgif-dev 
      RUN apt-get install libpng-dev 
      RUN apt-get install libxpm-dev 
      RUN apt-get install libgtk-3-dev 
      RUN apt-get install libgnutls28-dev 
      RUN apt-get install libmagickcore-dev 
      RUN apt-get install libmagick++-dev

      RUN cd emacs/ && \
        ./autogen.sh && \
        ./configure --with-imagemagick

      RUN cd emacs/ && \
          make
      RUN cd emacs/ && \
        make install

      RUN  apt-get install ispell
      RUN  apt-get install ghostscript 
      RUN  apt-get install imagemagick 
      RUN git clone --depth 1 --branch release https://github.com/adobe-fonts/source-code-pro.git ~/.fonts/adobe-fonts/source-code-pro && \
         fc-cache -f -v ~/.fonts/adobe-fonts/source-code-pro


      # Cleanup
      RUN  apt-get purge build-essential \
             && apt-get autoremove \
             && rm -rf /tmp/* /var/lib/apt/lists/* /root/.cache/*
      # ^^^^^^^ Those layers are shared ^^^^^^^

      # Emacs
      RUN useradd -ms /bin/bash emacs

      ENV UNAME="emacser" \
          GNAME="emacs" \
          UHOME="/home/emacs" \
          UID="1000" \
          GID="1000" \
          WORKSPACE="/mnt/workspace" \
          SHELL="/bin/bash"

      # WORKDIR "${WORKSPACE}"

      USER emacs
      WORKDIR /home/emacs

      CMD ["bash", "-c", "emacs; /bin/bash"] 
#+end_src
 #+begin_src text :tangle (concat *TrampPrefix* *DockerFiles* "Dockerfile-spacemacs_base")
      FROM emacs_base

      USER emacs
      WORKDIR /home/emacs
      
      COPY ./dotspacemacs-tangled.el /home/emacs/.spacemacs

      RUN cd ~ && \
         git clone https://github.com/syl20bnr/spacemacs ~/.emacs.d && \
         cd ~/.emacs.d && \
         git fetch && \
         git checkout develop 

      CMD ["bash", "-c", "emacs; /bin/bash"] 
#+end_src

#+begin_src text :tangle (concat *TrampPrefix* *DockerFiles* ".dockerignore")
Dockerfile 
Dockerfile-spacemacs_base
Dockerfile-emacs_basedot
spacemacs-tangled.el
.dockerignore
#+end_src
** Build
#+begin_src bash :session *dockerBuild* :dir (concat *TrampPrefix* *DockerFiles*) :results none
  cp Dockerfile-emacs_base Dockerfile
  docker build -t emacs_base .
  echo Built emacs_base
#+end_src

#+begin_src bash  :dir (concat *TrampPrefix* *DockerFiles*)  :results raw drawer
  cp /home/dperrin/Dropbox/dotFiles/dotspacemacs-tangled.el dotspacemacs-tangled.el
  cp Dockerfile-spacemacs_base Dockerfile
  docker build -t spacemacs_base .
#+end_src
** helpers
#+name:currentEmacsContainer
#+begin_src bash :var dockerName=`,*docker_id* :results value
  docker ps | grep emacs | awk '{ print $1 }'
 #+end_src

 #+RESULTS:
 : f7e38adffa14

#+name:commitCurrent 
#+begin_src bash :var id=currentEmacsContainer name="not_a_name" :results raw drawer
  docker commit $id $name
 #+end_src
** First Run
#+begin_src bash :dir `,*TrampPrefix* :var dockerName=`,*docker_id* :results raw drawer
  export DISPLAY=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2; exit;}'):0.0
  docker run --rm --name emacs -e DISPLAY=$DISPLAY spacemacs_base
 #+end_src

Before it shutting the first run down commit the container to capture the emacs installs

#+call:commitCurrent(name="spacemacs_inited") 
 
#+begin_src bash :dir `,*TrampPrefix* :var dockerName=`,*docker_id* :results raw drawer
  export DISPLAY=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2; exit;}'):0.0
  docker run --rm --name emacs -e DISPLAY=$DISPLAY spacemacs_inited
 #+end_src

*** TODO .emacs.d should probably have the org .ele files deleted there seen to be a melpa version problem with them

#+begin_src bash :results raw drawer
 #docker login
 docker tag $(docker images | grep spacemacs_inited | awk '{print $3}') dperrin/emacs:firsttry
 docker push dperrin/emacs 
 #+end_src


** Python?
** Latex
** slime stuff
 #+begin_src lisp 
   #!/usr/local/bin/sbcl --script
   (quicklisp-quickstart:install)
   (ql:add-to-init-file)
   (ql:quickload "quicklisp-slime-helper")
   (quit)
    #+end_src

 #+begin_src lisp 
   #!/usr/local/bin/sbcl --script
   ;;; blocks a input ... gerrrr
   (ql:add-to-init-file)
   (ql:quickload "quicklisp-slime-helper")
   (quit)
    #+end_src
* File Local Variables
# This Must be at the end of the file 
# Local Variables: 
# eval: (org-sbe "Execute-On-Load")
# End:

#  LocalWords:  JS html CSS AWS ECS APIs Keras rabbitmq
